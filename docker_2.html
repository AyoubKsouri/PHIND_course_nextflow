<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Docker 2 &mdash; PHINDaccess - Linux containers &amp; Nextflow for reproducible research and open science  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="canonical" href="https://biocorecrg.github.io/PHIND_course_nextflow_Feb_2022/docker_2.html" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Singularity" href="singularity.html" />
    <link rel="prev" title="Docker" href="docker.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> PHINDaccess - Linux containers & Nextflow for reproducible research and open science
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="about.html">About the course</a></li>
<li class="toctree-l1"><a class="reference internal" href="containers.html">Containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Docker</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Docker 2</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#docker-recipes-build-your-own-images">Docker recipes: build your own images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#os-commands-in-image-building">OS commands in image building</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#update-and-upgrade-packages">Update and upgrade packages</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#building-recipes">Building recipes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#basic-instructions">Basic instructions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#more-instructions">More instructions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#docker-build">docker build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-tag">docker tag</a></li>
<li class="toctree-l3"><a class="reference internal" href="#build-cache">Build cache</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#additional-commands">Additional commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exercises">Exercises</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="singularity.html">Singularity</a></li>
<li class="toctree-l1"><a class="reference internal" href="nextflow_1.html">Introduction to Nextflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="nextflow_2.html">Nextflow 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="nextflow_3.html">Nextflow 3</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">PHINDaccess - Linux containers & Nextflow for reproducible research and open science</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Docker 2</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/docker_2.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="docker-2">
<span id="docker-2-page"></span><h1>Docker 2<a class="headerlink" href="#docker-2" title="Permalink to this headline"></a></h1>
<section id="docker-recipes-build-your-own-images">
<h2>Docker recipes: build your own images<a class="headerlink" href="#docker-recipes-build-your-own-images" title="Permalink to this headline"></a></h2>
<section id="os-commands-in-image-building">
<h3>OS commands in image building<a class="headerlink" href="#os-commands-in-image-building" title="Permalink to this headline"></a></h3>
<p>Depending on the underlying OS, there are different ways to build images.</p>
<p>Know your base system and their packages. Popular ones:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://packages.debian.org">Debian</a></p></li>
<li><p><a class="reference external" href="https://centos.pkgs.org/">CentOS</a></p></li>
<li><p><a class="reference external" href="https://pkgs.alpinelinux.org/packages">Alpine</a></p></li>
<li><p>Conda. <a class="reference external" href="https://anaconda.org/anaconda/repo">Anaconda</a>, <a class="reference external" href="https://conda-forge.org/feedstocks/">Conda-forge</a>, <a class="reference external" href="https://anaconda.org/bioconda/repo">Bioconda</a>, etc.</p></li>
</ul>
<section id="update-and-upgrade-packages">
<h4>Update and upgrade packages<a class="headerlink" href="#update-and-upgrade-packages" title="Permalink to this headline"></a></h4>
<ul class="simple">
<li><p>In <strong>Ubuntu</strong>:</p></li>
</ul>
<p>In <strong>CentOS</strong>:</p>
<p>### Search and install packages:</p>
<ul class="simple">
<li><p>In <strong>Ubuntu</strong>:</p></li>
</ul>
<ul class="simple">
<li><p>In <strong>CentOS</strong>:</p></li>
</ul>
<p>&gt;Note the <strong>-y</strong> option that we set for updating and for installing.&lt;br&gt;
It is an important option in the context of Docker: it means that you <em>answer yes to all questions</em> regarding installation.</p>
</section>
</section>
<section id="building-recipes">
<h3>Building recipes<a class="headerlink" href="#building-recipes" title="Permalink to this headline"></a></h3>
<p>All commands should be saved in a text file, named by default <strong>Dockerfile</strong>.</p>
<section id="basic-instructions">
<h4>Basic instructions<a class="headerlink" href="#basic-instructions" title="Permalink to this headline"></a></h4>
<p>Each row in the recipe corresponds to a <strong>layer</strong> of the final image.</p>
<p><strong>FROM</strong>: parent image. Typically, an operating system. The <strong>base layer</strong>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">18.04</span>
</pre></div>
</div>
<p><strong>RUN</strong>: the command to execute inside the image filesystem.</p>
<p>Think about it this way: every <strong>RUN</strong> line is essentially what you would run to install programs on a freshly installed Ubuntu OS.</p>
<p>A basic recipe:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">18.04</span>

<span class="n">RUN</span> <span class="n">apt</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">upgrade</span>
<span class="n">RUN</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">wget</span>
</pre></div>
</div>
</section>
<section id="more-instructions">
<h4>More instructions<a class="headerlink" href="#more-instructions" title="Permalink to this headline"></a></h4>
<p><strong>MAINTAINER</strong></p>
<p>Who is maintaining the container?</p>
<p><strong>WORKDIR</strong>: all subsequent actions will be executed in that working directory</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WORKDIR</span> <span class="o">~</span>
</pre></div>
</div>
<p><strong>ADD, COPY</strong>: add files to the image filesystem</p>
<p>Difference between ADD and COPY explained <a class="reference external" href="https://stackoverflow.com/questions/24958140/what-is-the-difference-between-the-copy-and-add-commands-in-a-dockerfile">here</a> and <a class="reference external" href="https://nickjanetakis.com/blog/docker-tip-2-the-difference-between-copy-and-add-in-a-dockerile">here</a></p>
<p><strong>COPY</strong>: lets you copy a local file or directory from your host (the machine from which you are building the image)</p>
<p><strong>ADD</strong>: same, but ADD works also for URLs, and for .tar archives that will be automatically extracted upon being copied.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># COPY source destination</span>
<span class="n">COPY</span> <span class="o">~/.</span><span class="n">bashrc</span> <span class="o">.</span>
</pre></div>
</div>
<p><strong>ENV, ARG</strong>: run and build environment variables</p>
<p>Difference between ARG and ENV explained <a class="reference external" href="https://vsupalov.com/docker-arg-vs-env/">here</a>.</p>
<ul class="simple">
<li><p><strong>ARG</strong> values: available only while the image is built.</p></li>
<li><p><strong>ENV</strong> values: available for the future running containers.</p></li>
</ul>
<p><strong>CMD, ENTRYPOINT</strong>: command to execute when generated container starts</p>
<p>The ENTRYPOINT specifies a command that will always be executed when the container starts. The CMD specifies arguments that will be fed to the ENTRYPOINT</p>
<p>In the example below, when the container is run without an argument, it will execute <cite>echo “hello world”</cite>.
If it is run with the argument <strong>nice</strong> it will execute <cite>echo “nice”</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">18.04</span>
<span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/bin/echo&quot;</span><span class="p">]</span>
<span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;hello world&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>A more complex recipe (save it in a text file named <strong>Dockerfile</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">18.04</span>

<span class="n">MAINTAINER</span> <span class="n">Toni</span> <span class="n">Hermoso</span> <span class="n">Pulido</span> <span class="o">&lt;</span><span class="n">toni</span><span class="o">.</span><span class="n">hermoso</span><span class="nd">@crg</span><span class="o">.</span><span class="n">eu</span><span class="o">&gt;</span>

<span class="n">WORKDIR</span> <span class="o">~</span>

<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">upgrade</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">wget</span>

<span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/wget&quot;</span><span class="p">]</span>
<span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;https://cdn.wp.nginx.com/wp-content/uploads/2016/07/docker-swarm-hero2.png&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="docker-build">
<h3>docker build<a class="headerlink" href="#docker-build" title="Permalink to this headline"></a></h3>
<p>Implicitely looks for a <strong>Dockerfile</strong> file in the current directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker build .</span>
</pre></div>
</div>
<p>Same as:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker build --file Dockerfile .</span>
</pre></div>
</div>
<p>Syntax: <strong>–file / -f</strong></p>
<p><strong>.</strong> stands for the context (in this case, current directory) of the build process. This makes sense if copying files from filesystem, for instance. <strong>IMPORTANT</strong>: Avoid contexts (directories) overpopulated with files (even if not actually used in the recipe).</p>
<p>You can define a specific name for the image during the build process.</p>
<p>Syntax: <strong>-t</strong> <em>imagename:tag</em>. If not defined <code class="docutils literal notranslate"><span class="pre">`:tag`</span></code> default is latest.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker build -t mytestimage .</span>
</pre></div>
</div>
<p>The last line of installation should be <strong>Successfully built …</strong>: then you are good to go.</p>
<p>Check with <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">images</span></code> that you see the newly built image in the list…</p>
<p>Then let’s check the ID of the image and run it!</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker images</span>

<span class="go">docker run f9f41698e2f8</span>
<span class="go">docker run mytestimage</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker run f9f41698e2f8 https://cdn-images-1.medium.com/max/1600/1*_NQN6_YnxS29m8vFzWYlEg.png</span>
</pre></div>
</div>
</section>
<section id="docker-tag">
<h3>docker tag<a class="headerlink" href="#docker-tag" title="Permalink to this headline"></a></h3>
<p>To tag a local image with ID “e23aaea5dff1” into the “ubuntu_wget” image name repository with version “1.0”:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker tag e23aaea5dff1 --tag ubuntu_wget:1.0</span>
</pre></div>
</div>
</section>
<section id="build-cache">
<h3>Build cache<a class="headerlink" href="#build-cache" title="Permalink to this headline"></a></h3>
<p>Every line of a Dockerfile is actually an image/layer by itself.</p>
<p>Modify for instance the last bit of the previous image (let’s change the image URL) and rebuild it (even with a different name/tag):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">18.04</span>

<span class="n">MAINTAINER</span> <span class="n">Toni</span> <span class="n">Hermoso</span> <span class="n">Pulido</span> <span class="o">&lt;</span><span class="n">toni</span><span class="o">.</span><span class="n">hermoso</span><span class="nd">@crg</span><span class="o">.</span><span class="n">eu</span><span class="o">&gt;</span>

<span class="n">WORKDIR</span> <span class="o">~</span>

<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">upgrade</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">wget</span>

<span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/wget&quot;</span><span class="p">]</span>
<span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;https://cdn-images-1.medium.com/max/1600/1*_NQN6_YnxS29m8vFzWYlEg.png&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker build -t mytestimage2 .</span>
</pre></div>
</div>
<p>It will start from the last line.
This is OK most of the times and very convenient for testing and trying new steps, but it may lead to errors when versions are updated (either FROM image or included packages). For that it is benefitial to start from scratch with <code class="docutils literal notranslate"><span class="pre">`--no-cache`</span></code> tag.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker build --no-cache -t mytestimage2 .</span>
</pre></div>
</div>
</section>
</section>
<section id="additional-commands">
<h2>Additional commands<a class="headerlink" href="#additional-commands" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p><strong>docker inspect</strong>: Get details from containers (both running and stopped). Things such as IPs, volumes, etc.</p></li>
<li><p><strong>docker logs</strong>: Get <em>console</em> messages from running containers. Useful when using with web services.</p></li>
<li><p><strong>docker commit</strong>: Turn a container into an image. It make senses to use when modifying container interactively. However this is bad for reproducibility if no steps are saved.</p></li>
</ul>
<p>Good for long-term reproducibility and for critical production environments:</p>
<ul class="simple">
<li><p><strong>docker save</strong>: Save an image into a tar archive.</p></li>
<li><p><strong>docker export</strong>: Save a container into a tar archive.</p></li>
<li><p><strong>docker import</strong>: Import a tar archive into an image.</p></li>
</ul>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline"></a></h2>
<p>We explore interactively the different examples in the container/docker folders.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="docker.html" class="btn btn-neutral float-left" title="Docker" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="singularity.html" class="btn btn-neutral float-right" title="Singularity" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>